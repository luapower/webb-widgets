<!DOCTYPE html>
<html>
<head>
<title>X-MODULE</title>
<meta charset="utf-8">
<style>

* { box-sizing: border-box; }

@font-face {
	font-family: "x-widget";
	src: url("/OpenSans-Regular.ttf");
}

@font-face {
	font-family: "x-widget";
	src: url("/OpenSans-SemiBold.ttf");
	font-weight: bold;
}

</style>

<script src="ace.js" integrity="sha256-+svOVB1WmhKhTy7N21gWvtyXn91qF0r52P2hIArRRug="></script>

<link rel="stylesheet" type="text/css" href="fontawesome.css">
<link rel="stylesheet" type="text/css" href="x-widgets.css">

<script src="glue.js"></script>
<script src="divs.js"></script>
<script src="ajax.js"></script>
<script src="url.js"></script>
<script src="x-widgets.js"></script>
<script src="x-rowset-widget.js"></script>
<script src="x-listbox.js"></script>
<script src="x-grid.js"></script>
<script src="x-calendar.js"></script>
<script src="x-country-dropdown.js"></script>
<script src="x-cssgrid.js"></script>

</head>

<body>
<script>

// ---------------------------------------------------------------------------
// property inspector
// ---------------------------------------------------------------------------

property_inspector = component('x-property-inspector', function(e) {

	grid.construct(e)

	e.vertical = true
	e.auto_w = true

	e.save_row_on = 'input'
	e.exit_edit_on_lost_focus = false
	e.can_sort_rows = false
	e.enable_context_menu = false

	e.auto_edit_first_cell = true
	e.auto_enter_edit = true
	e.exit_edit_on_escape = false

	e.rowset = rowset({
		can_change_rows: true,
	})

	init = e.init
	e.init = function() {
		init_rowset(e.element)
		init()
	}

	e.rowset.on('value_changed', function(row, field, val) {
		e.element[field.name] = val
	})

	let element
	e.property('element',
		function() { return element },
		function(v) {
			element = v
			if (!e.__init_later)
				init_rowset(v)
		}
	)

	function init_rowset(element) {
		let props = []
		let res = {}
		res.fields = element.inspect_fields || []
		res.rows = [props]
		for (let field of res.fields)
			props.push(element[field.name])
		e.rowset.reset(res)
	}

})

// ---------------------------------------------------------------------------
// main app
// ---------------------------------------------------------------------------

body = document.body

root_widget = hsplit({
	1: button({text: 'Hello'}),
	2: button({text: 'Wazaa', primary: true}),
})

body.add(root_widget)

function properties_toolbox() {
	let pg = property_inspector({
		element: root_widget[1],
	})
	let tb = toolbox({
		title: 'properties',
		content: pg,
	})
	tb.inspector = pg
	return tb
}

function tree_toolbox() {
	function widget_name(e) {
		return e.tagName.lower()
	}
	let rows = new Set()

	function add_widget(e, pe) {
		if (!e) return
		rows.add([e, pe])
		if (e.child_widgets)
			for (let ce of e.child_widgets())
				add_widget(ce, e)
	}
	add_widget(root_widget)

	let rs = rowset({
		fields: [
			{name: 'widget', format: widget_name},
			{name: 'parent_widget', visible: false},
		],
		rows: rows,
		pk: 'widget',
		parent_col: 'parent_widget',
	})
	let g = grid({
		rowset: rs,
		tree_col: 'widget',
		header_visible: false,
	})
	g.on('focused_row_changed', function(row) {
		let e = row[0]
		props_tb.inspector.element = e
	})
	let tb = toolbox({
		title: 'widget tree',
		content: g,
	})
	return tb
}

function widgets_toolbox() {
	let lb = listbox({
		items: [
			'button', 'checkbox', 'radiogroup',
			'input', 'spin_input', 'slider',
			'list_dropdown', 'date_dropdown', 'grid_dropdown',
			'listbox', 'grid',
			'split', 'pagelist', 'cssgrid',
		],
	})
	let tb = toolbox({
		title: 'widgets',
		content: lb,
	})
	tb.on('dblclick', function(ev) {
		let i = ev.target.index
		let name = lb.items[i]
		let cons = window[name]
		let e = cons()
		body.add(e)
	})
	return tb
}


widgets_tb = widgets_toolbox()
widgets_tb.x = 500
widgets_tb.show()
body.add(widgets_tb)

props_tb = properties_toolbox()
props_tb.x = 700
props_tb.show()
body.add(props_tb)

tree_tb = tree_toolbox()
tree_tb.x = 1000
tree_tb.show()
body.add(tree_tb)

</script>
</body>
</html>
